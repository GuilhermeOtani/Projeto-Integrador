<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:composition template="/template.xhtml">
        <ui:define name="body">
            <f:view locale="pt_BR" />

            <h:form id="formCompras">
                <p:growl id="messages" showDetail="true" />

                <div class="content">
                    <div class="container-fluid">

                        <p:dataTable id="tabelaCompras"
                                     value="#{compraListaControle.listaCompras}" 
                                     var="compra"
                                     rowKey="#{compra.id}" 
                                     scrollable="true" 
                                     scrollHeight="550"
                                     styleClass="ui-datatable-striped"
                                     emptyMessage="Nenhuma compra encontrada."
                                     style="table-layout: fixed;">

                            <p:column headerText="ID" sortBy="#{compra.id}" style="text-align: center">
                                <h:outputText value="#{compra.id}" />
                            </p:column>

                            <p:column headerText="Fornecedor" sortBy="#{compra.fornecedor.nome}" style="text-align: center">
                                <h:outputText value="#{compra.fornecedor.nome}" />
                            </p:column>

                            <p:column headerText="Data Compra" sortBy="#{compra.dataCompra}" style="text-align: center">
                                <div class="cell-content-wrapper">
                                    <i class="pi pi-calendar cell-icon"></i>
                                    <h:outputText value="#{compra.dataCompra}">
                                        <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Sao_Paulo"/>
                                    </h:outputText>
                                </div>
                            </p:column>

                            <p:column headerText="Qtd. Itens" style="text-align: center">
                                <span class="data-badge badge-items">
                                    #{compra.itemCompras != null ? compra.itemCompras.size() : 0}
                                </span>
                            </p:column>

                            <p:column headerText="Valor Total" sortBy="#{compra.valorTotal}" style="text-align: center">
                                <span class="data-badge badge-total">
                                    <h:outputText value="#{compra.valorTotal}">
                                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                                    </h:outputText>
                                </span>
                            </p:column>

                            <p:column headerText="Operações" style="text-align: center">
                                <p:commandButton icon="pi pi-info-circle" title="Detalhes da Compra"
                                                 styleClass="ui-button-info ui-button-flat"
                                                 oncomplete="PF('detalhesCompraDialog').show();"
                                                 update=":detalhesCompraForm:detalhesCompraPanel">
                                    <f:setPropertyActionListener target="#{compraListaControle.compraSelecionada}" value="#{compra}" />
                                </p:commandButton>
                                
                                <p:commandButton icon="pi pi-trash" title="Excluir"
                                                 styleClass="ui-button-danger"
                                                 oncomplete="PF('confirmDialogCompra').show();"
                                                 update=":confirmacaoCompraForm:confirmacaoCompraPanel">
                                    <f:setPropertyActionListener target="#{compraListaControle.compraSelecionada}" value="#{compra}" />
                                </p:commandButton>
                            </p:column>
                        </p:dataTable>

                    </div>
                </div>
            </h:form>

            <h:form id="detalhesCompraForm">
                <p:dialog id="detalhesCompraDialogId" widgetVar="detalhesCompraDialog"
                          header="Detalhes da Compra - ID #{compraListaControle.compraSelecionada.id}"
                          modal="true" resizable="false" width="650" appendTo="@(body)">

                    <p:outputPanel id="detalhesCompraPanel">
                        <h:panelGrid columns="2" columnClasses="detail-grid-label, detail-grid-value">
                            <h:outputText value="ID da Compra:" />
                            <h:outputText value="#{compraListaControle.compraSelecionada.id}"/>
                            <h:outputText value="Fornecedor:" />
                            <h:outputText value="#{compraListaControle.compraSelecionada.fornecedor.nome}" />
                            <h:outputText value="Data da Compra:" />
                            <h:outputText value="#{compraListaControle.compraSelecionada.dataCompra}">
                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="America/Sao_Paulo"/>
                            </h:outputText>
                            <h:outputText value="Valor Total:"/>
                            <h:outputText value="#{compraListaControle.compraSelecionada.valorTotal}">
                                <f:convertNumber type="currency" currencySymbol="R$ "/>
                            </h:outputText>
                        </h:panelGrid>

                        <p:outputPanel rendered="#{compraListaControle.compraSelecionada.itemCompras.size() > 0}">
                            <p class="detail-header">Itens da Compra</p>
                            <p:dataTable value="#{compraListaControle.compraSelecionada.itemCompras}" var="item"
                                         emptyMessage="Nenhum item encontrado.">

                                <p:column headerText="Produto" style="text-align: center">#{item.produto.nome}</p:column>
                                <p:column headerText="Qtd" style="width: 70px; text-align: center">#{item.quantidade}</p:column>
                                <p:column headerText="Preço Unitário" style="width: 120px; text-align: center">
                                    <h:outputText value="#{item.preco}">
                                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="Subtotal" style="width: 120px; text-align: center">
                                    <h:outputText value="#{item.subTotal}">
                                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                                    </h:outputText>
                                </p:column>
                            </p:dataTable>
                        </p:outputPanel>

                    </p:outputPanel>
                </p:dialog>
            </h:form>

            <h:form id="confirmacaoCompraForm">
                <p:outputPanel id="confirmacaoCompraPanel">
                    <p:dialog id="confirmDialogCompraId" widgetVar="confirmDialogCompra" header="Confirmar Exclusão"
                              modal="true" resizable="false" appendTo="@(body)" width="350">
                        <p:outputPanel>
                            <h:outputText value="Tem certeza que deseja excluir esta compra?" />
                            
                            <br/>
                            <br/> 
                            
                            <div style="text-align: center">
                                <p:commandButton value="Sim" icon="pi pi-check"
                                                 styleClass="ui-button-danger"
                                                 action="#{compraListaControle.excluirCompra(compraListaControle.compraSelecionada)}"
                                                 process="@this"
                                                 update=":formCompras:tabelaCompras :formCompras:messages"
                                                 oncomplete="PF('confirmDialogCompra').hide();" 
                                                 style="margin-right: 10px"/>

                                <p:commandButton value="Não" icon="pi pi-times" type="button"
                                                 styleClass="ui-button-secondary"
                                                 onclick="PF('confirmDialogCompra').hide();" />
                            </div>
                        </p:outputPanel>
                    </p:dialog>
                </p:outputPanel>
            </h:form>

        </ui:define>
    </ui:composition>
</html>