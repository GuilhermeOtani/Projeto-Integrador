<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:composition template="/template.xhtml">
        <ui:define name="body">
            <style >
                .modern-table.ui-datatable {
                    border: none;
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                    margin-top: 25px;
                }

                /* Cabeçalho da Tabela Principal */
                .modern-table .ui-datatable-thead > tr > th {
                    background: #f8f9fa;
                    color: #34495e;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    padding: 16px 12px !important; /* !important para garantir a sobreposição */
                    border: none;
                    border-bottom: 2px solid #e9ecef;
                    text-align: center;
                }

                /* Células da Tabela Principal */
                .modern-table .ui-datatable-tbody > tr > td {
                    padding: 14px 12px;
                    border-color: #e9ecef !important;
                    vertical-align: middle;
                    border-bottom-width: 1px; /* Linhas mais sutis */
                    border-top-width: 0;
                    border-left-width: 0;
                    border-right-width: 0;
                }

                /* Estilo para linhas zebradas (striped) */
                .modern-table.ui-datatable-striped .ui-datatable-tbody > tr.ui-row-odd {
                    background-color: #fdfdfd;
                }
                .modern-table.ui-datatable-striped .ui-datatable-tbody > tr.ui-row-even {
                    background-color: #f8f9fa;
                }

                /* Efeito de hover nas linhas */
                .modern-table .ui-datatable-tbody > tr:not(.ui-datatable-empty-message):hover {
                    background-color: #e6f7ff !important;
                    cursor: pointer;
                }

                /* Ícone para expandir a linha (Row Toggler) */
                .modern-table .ui-row-toggler {
                    color: #007bff;
                    transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
                }
                .modern-table .ui-datatable-tbody tr:hover .ui-row-toggler {
                    color: #0056b3;
                    transform: scale(1.1);
                }


                /* ---- Estilo da Linha Expandida (Row Expansion) ---- */
                .modern-table .ui-expanded-row-content {
                    background-color: #f8f9fa;
                    border: 0 !important;
                    padding: 0 !important;
                }

                /* Tabela Aninhada */
                .modern-table .ui-datatable-nested {
                    border: none !important;
                    width: 100%;
                }

                /* Cabeçalho da Tabela Aninhada */
                .modern-table .ui-datatable-nested .ui-datatable-thead > tr > th {
                    background-color: #e9ecef;
                    color: #495057;
                    padding: 12px !important;
                    font-weight: 500;
                    border: none;
                    text-align: center;
                }

                /* Células da Tabela Aninhada */
                .modern-table .ui-datatable-nested .ui-datatable-tbody > tr > td {
                    padding: 12px;
                    border: none;
                    border-bottom: 1px solid #dee2e6;
                    vertical-align: middle;
                    background: transparent !important; /* Garante fundo limpo */
                }

                .modern-table .ui-datatable-nested .ui-datatable-tbody > tr:last-child > td {
                    border-bottom: none;
                }


                /* ---- Componentes Específicos (Status e Botões) ---- */
                .data-badge {
                    padding: 5px 12px;
                    border-radius: 15px;
                    font-weight: bold;
                    font-size: 0.8em;
                    color: #fff;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .badge-danger {
                    background-color: #dc3545;
                    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
                }
                .badge-success {
                    background-color: #28a745;
                    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
                }
                .pi-check-circle {
                    font-size: 1.8em !important;
                    color: #28a745 !important;
                    vertical-align: middle;
                }

                /* ---- Paginação ---- */
                .modern-table .ui-paginator {
                    background-color: #f8f9fa;
                    border: none;
                    padding: 15px 10px;
                }
                .modern-table .ui-paginator .ui-paginator-page,
                .modern-table .ui-paginator .ui-paginator-first,
                .modern-table .ui-paginator .ui-paginator-prev,
                .modern-table .ui-paginator .ui-paginator-next,
                .modern-table .ui-paginator .ui-paginator-last {
                    color: #007bff;
                    border-radius: 50%;
                    height: 32px;
                    width: 32px;
                    margin: 0 3px;
                    transition: background-color 0.2s, color 0.2s;
                }
                .modern-table .ui-paginator .ui-paginator-page:hover,
                .modern-table .ui-paginator .ui-paginator-first:hover,
                .modern-table .ui-paginator .ui-paginator-prev:hover,
                .modern-table .ui-paginator .ui-paginator-next:hover,
                .modern-table .ui-paginator .ui-paginator-last:hover {
                    background-color: #e6f2ff;
                    color: #0056b3;
                }
                .modern-table .ui-paginator .ui-state-active {
                    background-color: #007bff;
                    color: #ffffff;
                    border: 1px solid #007bff;
                }

                /* Mensagem de "nenhum registro encontrado" */
                .modern-table .ui-datatable-empty-message > td {
                    text-align: center;
                    padding: 40px !important;
                    font-style: italic;
                    color: #6c757d;
                }
                .badge-warning {
                    background-color: #ffc107; /* Laranja/Amarelo de alerta */
                    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.4);
                }


            </style>
            <div class="dashboard-container">

                <f:view locale="pt_BR" />
                <h:form id="formContasReceber">
                    <p:growl id="messages" showDetail="true" />

                    <div class="content">
                        <div class="container-fluid">

                            <p:panel header="Filtros e Ações" style="margin-bottom: 20px;" styleClass="filter-panel-modern">
                                <div class="ui-fluid formgrid grid">

                                    <div class="field col-12 md:col-3">
                                        <p:outputLabel for="status" value="Status:" />
                                        <p:selectOneRadio id="status" value="#{contasReceberControle.mostraTodasContas}" layout="responsive" columns="2">
                                            <f:selectItem itemLabel="Em Aberto" itemValue="#{false}" />
                                            <f:selectItem itemLabel="Todas" itemValue="#{true}" />
                                            <p:ajax update="tabelaContas panelTotalizador" listener="#{contasReceberControle.buscarContas}" />
                                        </p:selectOneRadio>
                                    </div>

                                    <div class="field col-12 md:col-3">
                                        <p:outputLabel for="vencimento" value="Vencimento até:" />
                                        <p:calendar id="vencimento" value="#{contasReceberControle.dataFiltroVencimento}" pattern="dd/MM/yyyy" mask="true">
                                            <p:ajax event="dateSelect" update="tabelaContas panelTotalizador" listener="#{contasReceberControle.buscarContas}" />
                                        </p:calendar>
                                    </div>

                                    <div class="field col-12 md:col-3">
                                        <p:outputLabel for="filtroCliente" value="Nome do Cliente:" />
                                        <p:inputText id="filtroCliente" value="#{contasReceberControle.nomeClienteFiltro}" placeholder="Digite para buscar...">
                                            <p:ajax event="keyup" delay="500" update="tabelaContas panelTotalizador" listener="#{contasReceberControle.buscarContas}" />
                                        </p:inputText>
                                    </div>

                                    <div class="field col-12 md:col-3">
                                        <p:commandButton value="Limpar Filtros" icon="pi pi-refresh"
                                                         actionListener="#{contasReceberControle.limparFiltros}"
                                                         update="tabelaContas panelTotalizador @form"
                                                         styleClass="ui-button-secondary" style="width: 100%;"/>
                                    </div>

                                </div>
                            </p:panel>

                            <p:outputPanel id="panelTotalizador">
                                <div style="display: flex; justify-content: space-between; gap: 1rem; width: 100%;">

                                    <div style="flex: 1;">
                                        <div class="card total-aberto-card" style="padding: 15px; text-align: center;">
                                            <h:outputText value="TOTAL A RECEBER" styleClass="text-secondary" style="font-size: 0.9em; font-weight: bold;"/><br/>
                                            <h:outputText value="#{contasReceberControle.totalEmAberto}" style="font-size: 1.5em; font-weight: bold; color: #dc3545;">
                                                <f:convertNumber type="currency" currencySymbol="R$ " />
                                            </h:outputText>
                                        </div>
                                    </div>

                                    <div style="flex: 1;">
                                        <div class="card total-recebido-card" style="padding: 15px; text-align: center;">
                                            <h:outputText value="TOTAL RECEBIDO" styleClass="text-secondary" style="font-size: 0.9em; font-weight: bold;"/><br/>
                                            <h:outputText value="#{contasReceberControle.totalRecebido}" style="font-size: 1.5em; font-weight: bold; color: #28a745;">
                                                <f:convertNumber type="currency" currencySymbol="R$ " />
                                            </h:outputText>
                                        </div>
                                    </div>

                                    <div style="flex: 1;">
                                        <div class="card total-geral-card" style="padding: 15px; text-align: center;">
                                            <h:outputText value="TOTAL GERAL" styleClass="text-secondary" style="font-size: 0.9em; font-weight: bold;"/><br/>
                                            <h:outputText value="#{contasReceberControle.totalGeral}" style="font-size: 1.5em; font-weight: bold; color: #007bff;">
                                                <f:convertNumber type="currency" currencySymbol="R$ " />
                                            </h:outputText>
                                        </div>
                                    </div>

                                </div>
                            </p:outputPanel>
                            <p:dataTable id="tabelaContas" 
                                         value="#{contasReceberControle.listaVendasAgrupadas}" 
                                         var="venda"
                                         rowKey="#{venda.id}"
                                         paginator="true"
                                         rows="10"
                                         paginatorPosition="bottom"
                                         paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                         currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} records"
                                         rowsPerPageTemplate="10,20,50"
                                         emptyMessage="Nenhuma venda encontrada para os filtros aplicados."
                                         styleClass="modern-table ui-datatable-striped"> 
                                <p:column style="width:3rem; text-align: center;">
                                    <p:rowToggler />
                                </p:column>

                                <p:column headerText="Venda" sortBy="#{venda.id}" style="text-align: center;">
                                    <h:outputText value="#{venda.id}" style="font-weight: bold;"/>
                                </p:column>

                                <p:column headerText="Cliente" style="text-align: center;">
                                    <h:outputText value="#{venda.cliente.nome}" />
                                </p:column>

                                <p:column headerText="Total da Venda" style="text-align: center;" sortBy="#{venda.valorTotal}">
                                    <h:outputText value="#{venda.valorTotal}">
                                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Parcelas" style="text-align: center;">
                                    <h:outputText value="#{venda.parcelas.size()} de #{venda.numeroParcelas}" />
                                </p:column>

                                <p:rowExpansion>
                                    <p:dataTable value="#{venda.parcelas}" var="conta" styleClass="ui-datatable-nested">
                                        <p:column headerText="Status" style="text-align: center;">
                                            <span class="#{contasReceberControle.getStatusClass(conta)}">
                                                #{contasReceberControle.getStatus(conta)}
                                            </span>
                                        </p:column>



                                        <p:column headerText="Parcela" style="text-align: center;">
                                            <h:outputText value="#{conta.parcela}" />
                                        </p:column>

                                        <p:column headerText="Vencimento" style="text-align: center;">
                                            <h:outputText value="#{conta.dataVencimento}">
                                                <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Sao_Paulo"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Valor Parcela" style="text-align: center;">
                                            <h:outputText value="#{conta.valor}" style="font-weight: bold;">
                                                <f:convertNumber type="currency" currencySymbol="R$ "/>
                                            </h:outputText>
                                        </p:column> 
                                        <p:column headerText="Data Recebimento" style="text-align: center;">
                                            <h:panelGroup rendered="#{not empty conta.dataRecebimento}">
                                                <h:outputText value="#{conta.dataRecebimento}">
                                                    <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Sao_Paulo"/>
                                                </h:outputText>
                                            </h:panelGroup>
                                        </p:column>

                                        <p:column headerText="Ação" style="text-align: center;">
                                            <h:panelGroup rendered="#{empty conta.dataRecebimento}">
                                                <p:commandButton icon="pi pi-check" title="Registrar Recebimento"
                                                                 styleClass="ui-button-success"
                                                                 oncomplete="PF('confirmarRecebimentoDialog').show();"
                                                                 update=":confirmacaoRecebimentoForm:confirmacaoRecebimentoPanel :formContasReceber:tabelaContas :formContasReceber:messages :formContasReceber:panelTotalizador">
                                                    <f:setPropertyActionListener target="#{contasReceberControle.contaSelecionada}" value="#{conta}" />
                                                </p:commandButton>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{not empty conta.dataRecebimento}">
                                                <i class="pi pi-check-circle" style="font-size: 1.5em; color: green;" title="Conta já recebida"/>
                                            </h:panelGroup>
                                        </p:column>
                                    </p:dataTable>
                                </p:rowExpansion>

                            </p:dataTable>
                        </div>
                    </div>
                </h:form>

                <h:form id="confirmacaoRecebimentoForm">
                    <p:dialog widgetVar="confirmarRecebimentoDialog"
                              header="Confirmar Recebimento"
                              modal="true"
                              resizable="false"
                              width="450"
                              appendTo="@(body)">

                        <p:outputPanel id="confirmacaoRecebimentoPanel" style="padding: 1rem;">

                            <p:messages id="dialogMessages" showDetail="true" closable="true"/>

                            <h:panelGroup rendered="#{not empty contasReceberControle.contaSelecionada}">
                                <p style="font-size: 1.1em; line-height: 1.6;">
                                    Deseja registrar o recebimento da conta ID
                                    <h:outputText value="#{contasReceberControle.contaSelecionada.id}" style="font-weight: bold;"/>
                                    do cliente <h:outputText value="#{contasReceberControle.contaSelecionada.cliente.nome}" style="font-weight: bold;"/>
                                    no valor de
                                    <h:outputText value="#{contasReceberControle.contaSelecionada.valor}" style="font-weight: bold;">
                                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                                    </h:outputText>
                                    hoje?
                                </p>
                            </h:panelGroup>

                            <div style="text-align: right; margin-top: 20px;">
                                <p:commandButton value="Cancelar" icon="pi pi-times" type="button"
                                                 styleClass="ui-button-secondary"
                                                 onclick="PF('confirmarRecebimentoDialog').hide();" style="margin-right: 10px;"/>

                                <p:commandButton value="Confirmar" icon="pi pi-check"
                                                 styleClass="ui-button-success"
                                                 actionListener="#{contasReceberControle.registrarRecebimento}"
                                                 process="@this"
                                                 update=":formContasReceber:tabelaContas :formContasReceber:panelTotalizador :formContasReceber:messages"
                                                 oncomplete="if (!args.validationFailed) { PF('confirmarRecebimentoDialog').hide(); }"/>
                            </div>

                        </p:outputPanel>
                    </p:dialog>
                </h:form>

            </div>
        </ui:define>
    </ui:composition>
</html>
