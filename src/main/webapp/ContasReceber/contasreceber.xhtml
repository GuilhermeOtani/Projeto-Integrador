<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:composition template="/template.xhtml">
        <ui:define name="body">
            <div class="dashboard-container">

                <f:view locale="pt_BR" />
                <h:form id="formContasReceber">
                    <p:growl id="messages" showDetail="true" />

                    <div class="content">
                        <div class="container-fluid">

                            <p:panel header="Filtros e Ações" style="margin-bottom: 20px;" styleClass="filter-panel-modern">
                                <div class="ui-fluid formgrid grid">

                                    <div class="field col-12 md:col-3">
                                        <p:outputLabel for="status" value="Status:" />
                                        <p:selectOneRadio id="status" value="#{contasReceberControle.mostraTodasContas}" layout="responsive" columns="2">
                                            <f:selectItem itemLabel="Em Aberto" itemValue="#{false}" />
                                            <f:selectItem itemLabel="Todas" itemValue="#{true}" />
                                            <p:ajax update="tabelaContas panelTotalizador" listener="#{contasReceberControle.buscarContas}" />
                                        </p:selectOneRadio>
                                    </div>

                                    <div class="field col-12 md:col-3">
                                        <p:outputLabel for="vencimento" value="Vencimento até:" />
                                        <p:calendar id="vencimento" value="#{contasReceberControle.dataFiltroVencimento}" pattern="dd/MM/yyyy" mask="true">
                                            <p:ajax event="dateSelect" update="tabelaContas panelTotalizador" listener="#{contasReceberControle.buscarContas}" />
                                        </p:calendar>
                                    </div>

                                    <div class="field col-12 md:col-3">
                                        <p:outputLabel for="filtroCliente" value="Nome do Cliente:" />
                                        <p:inputText id="filtroCliente" value="#{contasReceberControle.nomeClienteFiltro}" placeholder="Digite para buscar...">
                                            <p:ajax event="keyup" delay="500" update="tabelaContas panelTotalizador" listener="#{contasReceberControle.buscarContas}" />
                                        </p:inputText>
                                    </div>

                                    <div class="field col-12 md:col-3">
                                        <p:commandButton value="Limpar Filtros" icon="pi pi-refresh"
                                                         actionListener="#{contasReceberControle.limparFiltros}"
                                                         update="tabelaContas panelTotalizador @form"
                                                         styleClass="ui-button-secondary" style="width: 100%;"/>
                                    </div>

                                </div>
                            </p:panel>

                            <p:outputPanel id="panelTotalizador">
                                <div style="display: flex; justify-content: space-between; gap: 1rem; width: 100%;">

                                    <div style="flex: 1;">
                                        <div class="card total-aberto-card" style="padding: 15px; text-align: center;">
                                            <h:outputText value="TOTAL A RECEBER" styleClass="text-secondary" style="font-size: 0.9em; font-weight: bold;"/><br/>
                                            <h:outputText value="#{contasReceberControle.totalEmAberto}" style="font-size: 1.5em; font-weight: bold; color: #dc3545;">
                                                <f:convertNumber type="currency" currencySymbol="R$ " />
                                            </h:outputText>
                                        </div>
                                    </div>

                                    <div style="flex: 1;">
                                        <div class="card total-recebido-card" style="padding: 15px; text-align: center;">
                                            <h:outputText value="TOTAL RECEBIDO" styleClass="text-secondary" style="font-size: 0.9em; font-weight: bold;"/><br/>
                                            <h:outputText value="#{contasReceberControle.totalRecebido}" style="font-size: 1.5em; font-weight: bold; color: #28a745;">
                                                <f:convertNumber type="currency" currencySymbol="R$ " />
                                            </h:outputText>
                                        </div>
                                    </div>

                                    <div style="flex: 1;">
                                        <div class="card total-geral-card" style="padding: 15px; text-align: center;">
                                            <h:outputText value="TOTAL GERAL" styleClass="text-secondary" style="font-size: 0.9em; font-weight: bold;"/><br/>
                                            <h:outputText value="#{contasReceberControle.totalGeral}" style="font-size: 1.5em; font-weight: bold; color: #007bff;">
                                                <f:convertNumber type="currency" currencySymbol="R$ " />
                                            </h:outputText>
                                        </div>
                                    </div>

                                </div>
                            </p:outputPanel>
                            <p:dataTable id="tabelaContas" value="#{contasReceberControle.listaContas}" var="conta"
                                         paginator="true"
                                         rows="15"
                                         paginatorPosition="bottom"
                                         paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                         currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} records"
                                         rowsPerPageTemplate="15,30,50"
                                         emptyMessage="Nenhuma conta encontrada para os filtros aplicados."
                                         styleClass="ui-datatable-striped ui-datatable-gridlines">

                                <p:column headerText="Status" style="width: 100px; text-align: center;">
                                    <span class="#{conta.dataRecebimento == null ? 'data-badge badge-danger' : 'data-badge badge-success'}">
                                        #{conta.dataRecebimento == null ? 'ABERTA' : 'RECEBIDA'}
                                    </span>
                                </p:column>

                                <p:column headerText="ID" sortBy="#{conta.id}" style="width: 70px; text-align: center;">
                                    <h:outputText value="#{conta.id}" />
                                </p:column>

                                <p:column headerText="Venda" sortBy="#{conta.venda.id}" style="width: 80px; text-align: center;">
                                    <h:outputText value="#{conta.venda.id}" />
                                </p:column>

                                <p:column headerText="Cliente" sortBy="#{conta.cliente.nome}" filterBy="#{conta.cliente.nome}" filterMatchMode="contains" style="text-align: center;">
                                    <h:outputText value="#{conta.cliente.nome}" />
                                </p:column>

                                <p:column headerText="Vencimento" sortBy="#{conta.dataVencimento}" style="width: 130px; text-align: center;">
                                    <h:outputText value="#{conta.dataVencimento}">
                                        <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Sao_Paulo"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Recebimento" sortBy="#{conta.dataRecebimento}" style="width: 130px; text-align: center;">
                                    <h:outputText value="#{conta.dataRecebimento}">
                                        <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Sao_Paulo"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Valor" sortBy="#{conta.valor}" style="width: 150px; text-align: center;">
                                    <h:outputText value="#{conta.valor}" style="font-weight: bold;">
                                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Ação" style="width: 80px; text-align: center;">

                                    <h:panelGroup rendered="#{empty conta.dataRecebimento}">
                                        <p:commandButton
                                            icon="pi pi-check"
                                            title="Registrar Recebimento"
                                            styleClass="ui-button-success"
                                            oncomplete="PF('confirmarRecebimentoDialog').show();"
                                            update=":confirmacaoRecebimentoForm:confirmacaoRecebimentoPanel">
                                            <f:setPropertyActionListener target="#{contasReceberControle.contaSelecionada}" value="#{conta}" />
                                        </p:commandButton>
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{not empty conta.dataRecebimento}">
                                        <i class="pi pi-check-circle"
                                           style="font-size: 1.5em; color: green;"
                                           title="Conta já recebida"/>
                                    </h:panelGroup>

                                </p:column>


                            </p:dataTable>

                        </div>
                    </div>
                </h:form>

                <h:form id="confirmacaoRecebimentoForm">
                    <p:dialog widgetVar="confirmarRecebimentoDialog"
                              header="Confirmar Recebimento"
                              modal="true"
                              resizable="false"
                              width="450"
                              appendTo="@(body)">

                        <p:outputPanel id="confirmacaoRecebimentoPanel" style="padding: 1rem;">

                            <p:messages id="dialogMessages" showDetail="true" closable="true"/>

                            <h:panelGroup rendered="#{not empty contasReceberControle.contaSelecionada}">
                                <p style="font-size: 1.1em; line-height: 1.6;">
                                    Deseja registrar o recebimento da conta ID
                                    <h:outputText value="#{contasReceberControle.contaSelecionada.id}" style="font-weight: bold;"/>
                                    do cliente <h:outputText value="#{contasReceberControle.contaSelecionada.cliente.nome}" style="font-weight: bold;"/>
                                    no valor de
                                    <h:outputText value="#{contasReceberControle.contaSelecionada.valor}" style="font-weight: bold;">
                                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                                    </h:outputText>
                                    hoje?
                                </p>
                            </h:panelGroup>

                            <div style="text-align: right; margin-top: 20px;">
                                <p:commandButton value="Cancelar" icon="pi pi-times" type="button"
                                                 styleClass="ui-button-secondary"
                                                 onclick="PF('confirmarRecebimentoDialog').hide();" style="margin-right: 10px;"/>

                                <p:commandButton value="Confirmar" icon="pi pi-check"
                                                 styleClass="ui-button-success"
                                                 actionListener="#{contasReceberControle.registrarRecebimento}"
                                                 process="@this"
                                                 update=":formContasReceber:tabelaContas :formContasReceber:panelTotalizador :formContasReceber:messages"
                                                 oncomplete="if (!args.validationFailed) { PF('confirmarRecebimentoDialog').hide(); }"/>
                            </div>

                        </p:outputPanel>
                    </p:dialog>
                </h:form>

            </div>
        </ui:define>
    </ui:composition>
</html>
