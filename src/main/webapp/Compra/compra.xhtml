<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="body">

        <h:head>    
            <style>
                html, body {
                    height: 100%;
                    margin: 0;
                    padding: 0;
                }
                .scroll-container {
                    height: 94vh;        /* ocupa toda a altura da tela */
                    overflow-y: auto;    /* ativa o scroll vertical */
                    padding: 1rem;
                    box-sizing: border-box;
                }
                .field {
                    margin-bottom: 1.2rem;
                }
                .salvar-button {
                    margin-top: 1rem;
                    background-color: #2196F3;
                    border: none;
                    color: white;
                }
                .salvar-button:hover {
                    background-color: #1976D2;
                }
                .valor-total-display {
                    font-size: 2em;
                    font-weight: bold;
                    color: #4CAF50;
                }
            </style>
        </h:head>

        <h:form id="formCompra">
            <div class="scroll-container">
                <p:growl id="msgs" showDetail="true" sticky="false" life="5000" />

                <p:panel header="Compra de Produtos" styleClass="p-fluid">
                    <div class="formgrid grid" style="gap: 1.5rem;">

                        <div class="field col-12 md:col-6">
                            <p:outputLabel for="fornecedor" value="Fornecedor:" />
                            <p:autoComplete id="fornecedor" value="#{compraControle.fornecedorSelecionado}"
                                            completeMethod="#{compraControle.completarFornecedor}"
                                            var="f" itemLabel="#{f.nome}" itemValue="#{f}"
                                            converter="#{fornecedorControle.fornecedorConverter}"
                                            required="true" requiredMessage="Fornecedor é obrigatório!"
                                            dropdown="true" placeholder="Digite ou selecione um fornecedor" />
                        </div>

                        <div class="field col-12 md:col-6">
                            <p:outputLabel for="produto" value="Produto:" />
                            <p:autoComplete id="produto" value="#{compraControle.produtoSelecionado}"
                                            completeMethod="#{compraControle.completarProduto}"
                                            var="p" itemLabel="#{p.nomeComEstoque}" itemValue="#{p}"
                                            converter="#{produtoControle.produtoConverter}"
                                            dropdown="true" placeholder="Digite ou selecione um produto">
                                <p:ajax event="itemSelect" update=":formCompra:detalhesProduto :formCompra:panelTotalizacao" />
                            </p:autoComplete>
                        </div>
                        <div class="field col-12 md:col-6">
                            <p:outputLabel value="Preço:" />
                            <h:panelGroup id="detalhesProduto">
                                <h:outputText value="#{compraControle.produtoSelecionado.valor}">
                                    <f:convertNumber type="currency" currencySymbol="R$" />
                                </h:outputText>
                            </h:panelGroup>
                        </div>

                        <div class="field col-12 md:col-6">
                            <p:outputLabel for="quantidade" value="Quantidade:" />
                            <p:spinner id="quantidade" value="#{compraControle.itemCompra.quantidade}" min="1" />
                        </div>
                    </div>


                </p:panel>



                <p:outputPanel id="panelTotalizacao">
                    <div class="card" style="margin-top: 2rem;">
                        <div class="grid">
                            <div class="col-12 md:col-8">
                                <p:panel header="Opções de Pagamento">
                                    <div class="formgrid grid">

                                        <div>
                                            <p:outputLabel value="Tipo de Pagamento:" style="margin-right: 1rem;"/>
                                            <br/>
                                            <br/>
                                            <p:selectOneRadio id="tipoPag" value="#{compraControle.tipoPagamento}" layout="responsive" columns="2">
                                                <f:selectItem itemLabel="À vista" itemValue="AVista" />
                                                <f:selectItem itemLabel="A prazo" itemValue="APrazo" />
                                                <p:ajax listener="#{compraControle.onTipoPagamentoChange}" update="panelOpcoesPagamento" />
                                            </p:selectOneRadio>
                                        </div>

                                    </div>

                                    <p:outputPanel id="panelOpcoesPagamento">

                                        <p:outputPanel id="panelAVista" rendered="#{compraControle.tipoPagamento == 'AVista'}">
                                            <div class="formgrid grid">
                                                <div class="field col-12 md:col-6" style="margin-top: 1rem;">
                                                    <p:outputLabel for="formaPagVista" value="Forma de Pagamento:" />
                                                    <p:selectOneMenu id="formaPagVista" value="#{compraControle.compra.formaPagamento}" 
                                                                     required="true" requiredMessage="Selecione a forma de pagamento!">
                                                        <f:selectItem itemLabel="Selecione..." itemValue="#{null}" noSelectionOption="true" />
                                                        <f:selectItem itemLabel="Dinheiro" itemValue="Dinheiro" />
                                                        <f:selectItem itemLabel="Cartão de Débito" itemValue="Cartão de Débito" />
                                                        <f:selectItem itemLabel="Cartão de Crédito (1x)" itemValue="Cartão de Crédito" />
                                                        <f:selectItem itemLabel="Pix" itemValue="Pix" />
                                                    </p:selectOneMenu>
                                                </div>
                                            </div>
                                        </p:outputPanel>

                                        <p:outputPanel id="panelParcelas" rendered="#{compraControle.tipoPagamento == 'APrazo'}">
                                            <div class="formgrid grid" style="margin-top: 1rem;">

                                                <div class="field col-12">
                                                    <p:outputLabel for="formaPagPrazo" value="Forma de Pagamento:" />
                                                    <p:selectOneMenu id="formaPagPrazo" value="#{compraControle.compra.formaPagamento}" 
                                                                     required="true" requiredMessage="Selecione a forma de pagamento a prazo!">
                                                        <f:selectItem itemLabel="Selecione..." itemValue="#{null}" noSelectionOption="true" />
                                                        <f:selectItem itemLabel="Boleto Bancário" itemValue="Boleto Bancário" />
                                                        <f:selectItem itemLabel="Carnê" itemValue="Carnê" />
                                                        <f:selectItem itemLabel="Cartão de Crédito (Parcelado)" itemValue="Cartão de Crédito Parcelado" />
                                                    </p:selectOneMenu>
                                                </div>

                                                <div class="field col-12 md:col-6">
                                                    <p:outputLabel for="numParcelas" value="Nº de Parcelas:" />
                                                    <p:spinner id="numParcelas" value="#{compraControle.compra.numeroParcelas}" min="1"/>
                                                </div>
                                                <div class="field col-12 md:col-6">
                                                    <p:outputLabel for="vencimento" value="Primeiro Vencimento:" />
                                                    <p:calendar id="vencimento" value="#{compraControle.dataPrimeiroVencimento}" pattern="dd/MM/yyyy" mask="true" />
                                                </div>
                                            </div>
                                        </p:outputPanel>

                                    </p:outputPanel>
                                </p:panel>
                            </div>
                            <p:commandButton value="Adicionar ao Carrinho" icon="pi pi-plus"
                                             actionListener="#{compraControle.adicionarItem}"
                                             update=":formCompra:tabelaItens :formCompra:msgs :formCompra:panelTotalizacao"
                                             styleClass="salvar-button" style="width: 100%; font-size: 1.2rem;" />

                            <p:panel header="Itens no Carrinho" styleClass="p-fluid" style="margin-top: 2rem;">
                                <p:dataTable id="tabelaItens" value="#{compraControle.compra.itemCompras}" var="item" style="width:100%"
                                             emptyMessage="Nenhum item adicionado à compra.">

                                    <p:column headerText="Produto">
                                        #{item.produto.nome}
                                    </p:column>
                                    <p:column headerText="Preço" style="text-align: center;">
                                        <h:outputText value="#{item.preco}">
                                            <f:convertNumber type="currency" currencySymbol="R$" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Quantidade" style="text-align: center;">
                                        #{item.quantidade}
                                    </p:column>
                                    <p:column headerText="Subtotal" style="text-align: center;">
                                        <h:outputText value="#{item.subTotal}">
                                            <f:convertNumber type="currency" currencySymbol="R$" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Ações" style="width: 80px; text-align: center;">
                                        <p:commandButton icon="pi pi-trash"
                                                         update=":formCompra:tabelaItens :formCompra:msgs :formCompra:panelTotalizacao"
                                                         actionListener="#{compraControle.removerItem(item)}"
                                                         styleClass="p-button-danger p-button-text" />
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                            <div class="col-12 md:col-4" style="text-align: right; align-self: center;">

                                <p:commandButton value="Finalizar Compra" icon="pi pi-check"
                                                 actionListener="#{compraControle.finalizarCompra}"
                                                 update="@form"
                                                 process="@form"
                                                 styleClass="salvar-button" style="width: 100%; font-size: 1.2rem;"/>
                            </div>
                        </div>
                    </div>
                </p:outputPanel>
            </div>
        </h:form>
    </ui:define>
</ui:composition>