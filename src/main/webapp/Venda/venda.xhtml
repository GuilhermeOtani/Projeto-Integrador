<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="body">

        <h:head>    
            <style>
                html, body {
                    height: 100%;
                    margin: 0;
                    padding: 0;
                }
                .scroll-container {
                    height: 94vh;        /* ocupa toda a altura da tela */
                    overflow-y: auto;    /* ativa o scroll vertical */
                    padding: 1rem;
                    box-sizing: border-box;
                }
                .field {
                    margin-bottom: 1.2rem;
                }
                .salvar-button {
                    margin-top: 1rem;
                    background-color: #2196F3;
                    border: none;
                    color: white;
                }
                .salvar-button:hover {
                    background-color: #1976D2;
                }
                .valor-total-display {
                    font-size: 2em;
                    font-weight: bold;
                    color: #4CAF50;
                }
            </style>
        </h:head>

        <h:form id="formVenda">
            <div class="scroll-container">
                <p:growl id="msgs" showDetail="true" sticky="false" life="5000" />

                <p:panel header="Venda de Produtos" styleClass="p-fluid">
                    <div class="formgrid grid" style="gap: 1.5rem;">

                        <div class="field col-12 md:col-6">
                            <p:outputLabel for="cliente" value="Cliente:" />
                            <p:selectOneMenu id="cliente" value="#{vendaControle.clienteSelecionado}" 
                                             converter="#{clienteControle.clienteConverter}" 
                                             required="true" requiredMessage="Cliente é obrigatório!">
                                <f:selectItem itemLabel="Selecione um cliente" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems value="#{vendaControle.listaClientes}" var="c" itemLabel="#{c.nome}" itemValue="#{c}" />
                            </p:selectOneMenu>
                        </div>

                        <div class="field col-12 md:col-6">
                            <p:outputLabel for="produto" value="Produto:" />
                            <p:selectOneMenu id="produto" value="#{vendaControle.produtoSelecionado}" 
                                             converter="#{produtoControle.produtoConverter}">
                                <f:selectItem itemLabel="Selecione um produto" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems value="#{vendaControle.listaProdutos}" var="p" itemLabel="#{p.nome} (Estoque: #{p.estoque})" itemValue="#{p}" />
                                <p:ajax event="change" update=":formVenda:detalhesProduto :formVenda:panelTotalizacao"/>
                            </p:selectOneMenu>
                        </div>
                        <div class="field col-12 md:col-6">
                            <p:outputLabel value="Preço:" />
                            <h:panelGroup id="detalhesProduto">
                                <h:outputText value="#{vendaControle.produtoSelecionado.valor}">
                                    <f:convertNumber type="currency" currencySymbol="R$" />
                                </h:outputText>
                            </h:panelGroup>
                        </div>

                        <div class="field col-12 md:col-6">
                            <p:outputLabel for="quantidade" value="Quantidade:" />
                            <p:spinner id="quantidade" value="#{vendaControle.itemVenda.quantidade}" min="1" />
                        </div>
                    </div>

                    <p:commandButton value="Adicionar ao Carrinho" icon="pi pi-plus"
                                     actionListener="#{vendaControle.adicionarItem}"
                                     update=":formVenda:tabelaItens :formVenda:msgs :formVenda:panelTotalizacao"
                                     styleClass="salvar-button" />
                </p:panel>



                <p:outputPanel id="panelTotalizacao">
                    <div class="card" style="margin-top: 2rem;">
                        <div class="grid">
                            <div class="col-12 md:col-8">
                                <p:panel header="Opções de Pagamento">
                                    <div class="formgrid grid">
                                        <div class="field col-12 md:col-6">
                                            <p:outputLabel for="formaPag" value="Forma de Pagamento:" />
                                            <p:selectOneMenu id="formaPag" value="#{vendaControle.venda.formaPagamento}" required="true" requiredMessage="Selecione a forma de pagamento!">
                                                <f:selectItem itemLabel="Selecione..." itemValue="#{null}" noSelectionOption="true" />
                                                <f:selectItem itemLabel="Dinheiro" itemValue="Dinheiro" />
                                                <f:selectItem itemLabel="Cartão de Débito" itemValue="Cartão de Débito" />
                                                <f:selectItem itemLabel="Cartão de Crédito" itemValue="Cartão de Crédito" />
                                                <f:selectItem itemLabel="Pix" itemValue="Pix" />
                                                <f:selectItem itemLabel="A Prazo" itemValue="A Prazo" />
                                                <p:ajax update="panelParcelas" />
                                            </p:selectOneMenu>
                                        </div>
                                    </div>

                                    <p:outputPanel id="panelParcelas">
                                        <div class="formgrid grid" style="margin-top: 1rem;" rendered="#{vendaControle.venda.formaPagamento == 'A Prazo'}">
                                            <div class="field col-12 md:col-6">
                                                <p:outputLabel for="numParcelas" value="Nº de Parcelas:" />
                                                <p:spinner id="numParcelas" value="#{vendaControle.venda.numeroParcelas}" min="1"/>
                                            </div>
                                            <div class="field col-12 md:col-6">
                                                <p:outputLabel for="vencimento" value="Primeiro Vencimento:" />
                                                <p:calendar id="vencimento" value="#{vendaControle.dataPrimeiroVencimento}" pattern="dd/MM/yyyy" mask="true" />
                                            </div>
                                        </div>
                                    </p:outputPanel>
                                </p:panel>
                            </div>
                            <p:panel header="Itens no Carrinho" styleClass="p-fluid" style="margin-top: 2rem;">
                                <p:dataTable id="tabelaItens" value="#{vendaControle.venda.itensVendas}" var="item" style="width:100%"
                                             emptyMessage="Nenhum item adicionado à venda.">

                                    <p:column headerText="Produto">
                                        #{item.produto.nome}
                                    </p:column>
                                    <p:column headerText="Preço" style="text-align: center;">
                                        <h:outputText value="#{item.preco}">
                                            <f:convertNumber type="currency" currencySymbol="R$" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Quantidade" style="text-align: center;">
                                        #{item.quantidade}
                                    </p:column>
                                    <p:column headerText="Subtotal" style="text-align: center;">
                                        <h:outputText value="#{item.subTotal}">
                                            <f:convertNumber type="currency" currencySymbol="R$" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Ações" style="width: 80px; text-align: center;">
                                        <p:commandButton icon="pi pi-trash"
                                                         update=":formVenda:tabelaItens :formVenda:msgs :formVenda:panelTotalizacao"
                                                         actionListener="#{vendaControle.removerItem(item)}"
                                                         styleClass="p-button-danger p-button-text" />
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                            <div class="col-12 md:col-4" style="text-align: right; align-self: center;">
                                <h:outputText value="VALOR TOTAL" style="font-size: 1.2rem; color: #6c757d;"/>
                                <br/>
                                <h:outputText value="#{vendaControle.venda.valorTotal}" styleClass="valor-total-display">
                                    <f:convertNumber type="currency" currencySymbol="R$ " />
                                </h:outputText>
                                <br/>
                                <p:commandButton value="Finalizar Venda" icon="pi pi-check"
                                                 actionListener="#{vendaControle.finalizarVenda}"
                                                 update="@form"
                                                 process="@form"
                                                 styleClass="salvar-button" style="width: 100%; font-size: 1.2rem;"/>
                            </div>
                        </div>
                    </div>
                </p:outputPanel>
            </div>
        </h:form>
    </ui:define>
</ui:composition>